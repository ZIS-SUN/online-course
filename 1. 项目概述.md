下面是一份可落地的 **《在线课程学习系统（视频播放与进度记录）PRD v1.0》**，按“前台 + 后台”“用户 + 管理员”的双端双角色设计，技术栈约束为：**前端 Vue、后端 Spring Boot、数据库 MySQL（本地开发默认账号 root/密码 1234）**。文档力求既清晰又能直接指导实现与验收。

> ⚠️ 安全提醒：root/1234 仅用于**本地开发**与课程演示，任何部署环境必须修改为强密码并限制权限。

------

## 1. 项目概述

**目标**
 构建一个支持课程管理、章节/视频播放、**学习进度记录与续播**的在线学习系统，包含学员端（前台）与管理员端（后台）。支持基础统计与权限控制，满足毕业设计演示与答辩。

**不在本期范围（v1.0 以后规划）**
 付费/订单、题库考试、直播、弹题互动、复杂反刷课、CDN/对象存储接入的自动转码任务流等（PRD 中会给出可选方案与扩展点）。

------

## 2. 角色与权限

- **访客（未登录）**：浏览课程列表/详情，试看标记为“可试看”的视频片段；登录/注册。
- **学员（USER）**：选课、完整播放课程视频、记录/同步学习进度、我的课程、继续学习、观看历史、收藏课程、基本资料修改。
- **管理员（ADMIN）**：课程/章节/视频 CRUD、视频上传（本地存储版）、用户管理、发布/下架、进度与学习概览、审计日志。

**权限矩阵（摘要）**

| 功能                | 访客 | 学员  | 管理员       |
| ------------------- | ---- | ----- | ------------ |
| 浏览课程/详情       | 读   | 读    | 读           |
| 试看视频            | 读   | 读    | 读           |
| 全量播放            | -    | 读    | 读           |
| 学习进度读/写       | -    | 读/写 | 读           |
| 选课/退课           | -    | 写    | 写（代操作） |
| 课程/章节/视频 CRUD | -    | -     | 读/写        |
| 用户管理            | -    | -     | 读/写        |
| 视频上传            | -    | -     | 写           |
| 审计日志            | -    | -     | 读           |

------

## 3. 核心用户故事（节选）

- 作为学员，我可以**选课后播放视频**，退出后再次进入能**从上次位置继续**学习。
- 作为学员，我希望系统**实时记录进度**（每隔几秒/关键节点）并在不同设备同步。
- 作为管理员，我能**新建课程**、添加**章节与视频**，上传视频文件并**发布课程**。
- 作为管理员，我能**查看某课程整体学习完成率**以及某学员的视频完成情况。

------

## 4. 功能清单

### 4.1 前台（学员端）

1. **登录/注册/退出**
   - 手机/邮箱 + 密码（演示可二选一）；密码规则与校验；JWT 会话。
2. **首页/课程列表**
   - 搜索（标题关键字）、分类筛选、分页、课程卡片（封面、标题、章节数、学习人数）。
3. **课程详情**
   - 课程简介、目录（章节/视频树）、试看标识、选课按钮、已学进度。
4. **视频播放页**
   - 播放器（支持倍速、进度条、全屏、音量、快捷键）。
   - **进度记录**：启动时拉取服务器进度；播放中心跳上报；暂停/结束/页面卸载时立即上报；**断点续播**。
   - 同步进度到课程层展示（百分比、是否完成）。
5. **我的学习**
   - 我的课程（进度、继续学习按钮）；观看历史；收藏/取消收藏。
6. **个人中心**
   - 基本信息、头像（可选）、密码修改（强校验）。

### 4.2 后台（管理员端）

1. **登录（ADMIN）**
2. **课程管理**
   - 新建/编辑/发布/下架；封面上传；分类、难度；课程排序。
3. **章节管理**
   - 增删改查，章节排序。
4. **视频管理**
   - 新增视频：标题、所属章节、**视频源地址/上传**、时长、排序、是否可试看。
   - 视频上传（本地文件，MP4 优先；可留 HLS m3u8 字段以便升级）。
5. **用户管理**
   - 学员列表，重置密码，封禁/解封。
6. **学习统计（基础）**
   - 课程总学员数、完成率；按视频查看完成率/平均观看时长；按学员查看进度。
7. **审计日志**
   - 记录管理员关键操作（创建/删除/发布等）。

------

## 5. 业务流程（关键）

### 5.1 登录认证（JWT）

- 登录成功返回 `accessToken`（短效）与 `refreshToken`（长效）；前端刷新逻辑透明；演示版可只用 `accessToken` 简化。

### 5.2 选课

- 学员点击“选课”→ 创建/激活 `enrollment` 记录；课程目录解锁。

### 5.3 播放与进度记录

1. 进入视频播放页：
   - 前端 `GET /videos/{id}/progress` 拉取服务器进度；
   - 若 `lastPosition > 0 && !isCompleted`，弹窗选择“**从上次位置继续**/从头播放”。
2. 播放中：
   - `timeupdate`（前端 250ms 触发）→ 前端**节流**为**每 5 秒或进度增长 ≥3%**时 `PATCH /videos/{id}/progress`；
   - 发生 `pause`/`ended`/页面关闭：立即上报一次。
3. 服务端更新策略：
   - 更新 `last_position_seconds`；
   - 更新 `max_position_seconds = max(old, current)`（简单反刷课策略）；
   - 计算 `percentage = max_position_seconds / duration * 100`；
   - 若 `last_position_seconds >= duration * 0.9` 或 `ended` 事件则 `is_completed = 1`。
4. 课程进度：
   - 由各视频完成情况**聚合**得到（完成视频数 / 总视频数）。

> 说明：v1.0 采用“**最大到达位置**”的简易防跳过方案，易于实现；v1.1 可升级为“观看区间合并”避免单点跳尾作弊。

------

## 6. 信息架构与导航

**前台：** 首页 → 课程列表/搜索 → 课程详情 →（选课）→ 播放页 → 我的学习/历史/收藏 → 个人中心。
 **后台：** 仪表盘 → 课程 →（进入）章节 →（进入）视频 → 用户 → 统计 → 审计日志 → 设置。

**关键页面要点**

- **课程详情**：目录树（章节 → 视频），显示每个视频的学习状态（未开始/进行中/已完成）。
- **播放页**：左侧目录/播放列表，右侧播放器与简介；顶部显示课程标题与返回；底部显示已学百分比与“继续学习”。
- **后台课程编辑**：分步：基本信息 → 目录编辑 → 视频管理 → 预览 → 发布。

------

## 7. 数据设计（MySQL）

> 字段类型以 MySQL 8 为准；时间均为 `DATETIME`（后端以 UTC 存储、前端本地化）。

### 7.1 核心实体

- `users(id, username, password_hash, role[USER/ADMIN], email, phone, avatar_url, status, created_at, updated_at)`
- `categories(id, name, parent_id, sort_order)`
- `courses(id, title, subtitle, description, cover_url, category_id, level[BEGINNER/INTERMEDIATE/ADVANCED], status[DRAFT/PUBLISHED/ARCHIVED], is_free, created_by, created_at, updated_at)`
- `sections(id, course_id, title, sort_order, created_at)`
- `videos(id, section_id, title, source_url, hls_url, duration_seconds, size_bytes, sort_order, is_free_preview, transcode_status, created_at)`
- `enrollments(id, user_id, course_id, status[ACTIVE/COMPLETED/DROPPED], enrolled_at)`
- `video_progress(id, user_id, video_id, last_position_seconds, max_position_seconds, percentage, is_completed, playback_rate, updated_at, created_at)`
- `favorites(id, user_id, course_id, created_at)`
- `play_history(id, user_id, video_id, position_seconds, watched_at)`
- `audit_logs(id, operator_id, action, target_type, target_id, details, created_at)`

**关系简图（ASCII）**

```
users (1) ──< enrollments >── (1) courses ──< sections ──< videos
   │                           │                     │
   └─< video_progress >── videos                     └─< play_history
   └─< favorites >── courses
```

------

## 8. API 设计（REST，JSON）

> 统一响应：`{ code: 0, message: "ok", data: ... }`；错误码非 0。管理员端统一加 `ROLE_ADMIN` 鉴权。

### 8.1 认证

- `POST /api/auth/register` `{username, email/phone, password}`
- `POST /api/auth/login` `{username, password}` → `{accessToken, user}`
- `GET /api/auth/me`
- `POST /api/auth/logout`
- （可选）`POST /api/auth/refresh`

### 8.2 课程/目录/选课

- `GET /api/courses?keyword=&categoryId=&page=&size=`
- `GET /api/courses/{courseId}`
- `GET /api/courses/{courseId}/outline`（章节+视频树）
- `POST /api/courses/{courseId}/enroll`
- `GET /api/users/me/courses?status=`（我的课程）
- `GET /api/courses/{courseId}/progress`（聚合进度）

### 8.3 视频与进度

- `GET /api/videos/{videoId}` → 基础信息 + **播放地址（source_url 或安全签发的临时 URL）**

- `GET /api/videos/{videoId}/progress`

- `PATCH /api/videos/{videoId}/progress`

  ```json
  {
    "positionSeconds": 123,
    "durationSeconds": 300,
    "event": "heartbeat|pause|end|seek",
    "maxPositionSeconds": 150,
    "playbackRate": 1.0,
    "device": "web_chrome",
    "clientTime": "2025-09-26T12:34:56Z"
  }
  ```

  **响应**

  ```json
  {
    "isCompleted": false,
    "percentage": 50.0,
    "resumeFrom": 123
  }
  ```

### 8.4 收藏/历史

- `POST /api/courses/{courseId}/favorite`
- `DELETE /api/courses/{courseId}/favorite`
- `GET /api/users/me/history?page=&size=`

### 8.5 后台（ADMIN）

- `POST /api/admin/courses`（建/改/删/查全套）
- `POST /api/admin/sections` / `PUT /{id}` / `DELETE /{id}` / 排序
- `POST /api/admin/videos` / `PUT /{id}` / `DELETE /{id}` / 排序
- `POST /api/admin/videos/upload`（multipart，返回 `source_url`）
- `PUT /api/admin/courses/{id}/publish` / `/archive`
- `GET /api/admin/stats/courses/{courseId}`（完成率、学员数、视频完成分布）
- `GET /api/admin/users` / `PUT /api/admin/users/{id}/reset-password` / `PUT /{id}/status`
- `GET /api/admin/audit-logs?page=&size=`

**安全**：所有非 GET 写操作要求 JWT，管理端需 `ROLE_ADMIN`；开启后端参数校验与操作审计。

------

## 9. 前后端与媒体技术方案

### 9.1 前端（Vue）

- **框架**：Vue 3 + Vite（可 JS 或 TS），路由 Vue Router 4，状态 Pinia。
- **UI**：Element Plus（表单校验、表格、分页、上传、弹窗）。
- **HTTP**：Axios（请求拦截器注入 token，响应拦截器统一错误处理）。
- **播放器**：优先使用 `video.js`（或原生 `<video>` + `hls.js`）。
  - v1.0：支持 MP4 渐进式播放；
  - v1.1（可选）：支持 HLS（`.m3u8`）并启用多码率自适应。
- **进度上报**：`timeupdate` 节流到 5s/≥3%；`beforeunload`/`visibilitychange` 兜底上报。

### 9.2 后端（Spring Boot）

- Spring Boot 3.x、Spring Web、Spring Data JPA（或 MyBatis）、Spring Security + JWT、Hibernate Validator、Lombok、Flyway（或 Liquibase）做 SQL 迁移。
- 日志：Logback，关键接口与管理员操作打审计日志。
- 跨域：开发环境启用 CORS；部署用 Nginx 反向代理。

### 9.3 数据库（MySQL）

- 本地：`root/1234`（仅开发）。
- 生产：独立账号/库、最小权限、强密码、每日备份。

### 9.4 媒体存储与分发（v1.0 简化）

- **存储**：本地磁盘 `uploads/videos/`，访问通过后端签发受控 URL 或 Nginx 限制目录。
- **编码**：MP4（H.264/AAC），便于浏览器直接播放。
- **可选升级**：FFmpeg 转 HLS（.m3u8 + .ts），Nginx 或对象存储 + CDN；支持分段、断点续传与更好的网络自适应。

------

## 10. 非功能性要求（NFR）

- **性能**：单节点 QPS 100（示例），播放页首屏 < 2.5s；进度上报接口 < 100ms（P95，本地网）。
- **并发**：同时 200 学员播放不致崩溃（本地演示可降级）。
- **兼容性**：Chrome/Edge/Firefox 最新版、移动端浏览器（iOS/Android）基本可用。
- **可用性**：前端异常/断网自动重试上报；后端 UPSERT 语义，保证幂等。
- **安全**：密码 Bcrypt、JWT 过期与刷新、接口鉴权、SQL 注入与 XSS 防护、上传白名单（mp4）、大小限制（默认 ≤ 512MB，用于演示）。
- **隐私**：仅收集学习必要数据；日志不存敏感字段明文。
- **可维护性**：Flyway 版本化 SQL；分层清晰（controller/service/repo）。

------

## 11. 验收标准（核心用例）

| 用例       | 场景                       | 操作步骤                 | 预期结果                                                  |
| ---------- | -------------------------- | ------------------------ | --------------------------------------------------------- |
| 注册登录   | 学员首次使用               | 注册→登录                | 返回 JWT，进入首页，显示用户昵称                          |
| 选课       | 学员进入课程详情           | 点击“选课”               | enrollment 记录创建，目录解锁                             |
| 进度记录   | 播放 2 分钟后退出          | 进入播放→观看 120s→退出  | 服务器 `last_position≈120s`，下次进入弹出“从 2:00 继续？” |
| 完成判定   | 播放到 90% 以上            | 连续播放到末尾           | `is_completed=1`，课程聚合进度更新                        |
| 多设备同步 | A 端看 1 分钟，B 端打开    | A 退出→B 登录→进入同视频 | B 端拉取到 1 分钟的进度                                   |
| 后台发布   | 管理员建课程→上传视频→发布 | 完成发布                 | 前台课程可检索并选课播放                                  |
| 审计日志   | 管理员删除视频             | 删除操作                 | 审计日志记录操作人、对象、时间                            |

------

## 12. 风险与对策

- **大视频上传慢/失败**：限制大小；分块上传（v1.1）；后台进度条与断点续传。
- **刷课/快进作弊**：v1.0 以“最大到达位置”限制；v1.1 记录观看区间并合并。
- **视频盗链**：部署时通过签名 URL、Referer 校验、Nginx 私有目录或后端流式转发。
- **移动端息屏丢数据**：`visibilitychange` 与 `pagehide` 兜底上报；进入页面先同步服务器进度。
- **安全**：root/1234 禁止生产使用；上线前必须更改并限制白名单 IP。

------

## 13. 项目结构建议

**前端**

```
/src
  /api        # axios 封装与接口定义
  /components # 通用组件（播放器包装、进度条等）
  /pages      # Home/CourseDetail/Player/My/...
  /stores     # pinia
  /router
  /utils
```

**后端（Spring Boot）**

```
com.example.learn
  ├─ config        # 安全、CORS、Swagger
  ├─ auth          # JWT、用户登录
  ├─ course        # entity/repo/service/controller
  ├─ media         # 上传/访问
  ├─ progress      # 进度服务
  ├─ user          # 用户/管理员
  └─ audit         # 审计日志
```

------

## 14. SQL 结构（核心表，示例 DDL）

> 可直接用作 Flyway 初始脚本（根据需要调整引擎与字符集）。

```sql
-- users
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  nickname VARCHAR(50),
  email VARCHAR(100),
  phone VARCHAR(20),
  role ENUM('USER','ADMIN') NOT NULL DEFAULT 'USER',
  avatar_url VARCHAR(255),
  status TINYINT NOT NULL DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- categories
CREATE TABLE categories (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL,
  parent_id BIGINT DEFAULT NULL,
  sort_order INT DEFAULT 0
);

-- courses
CREATE TABLE courses (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(200) NOT NULL,
  subtitle VARCHAR(255),
  description TEXT,
  cover_url VARCHAR(255),
  category_id BIGINT,
  level ENUM('BEGINNER','INTERMEDIATE','ADVANCED') DEFAULT 'BEGINNER',
  status ENUM('DRAFT','PUBLISHED','ARCHIVED') NOT NULL DEFAULT 'DRAFT',
  is_free TINYINT NOT NULL DEFAULT 1,
  created_by BIGINT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (category_id) REFERENCES categories(id),
  FOREIGN KEY (created_by) REFERENCES users(id)
);

-- sections
CREATE TABLE sections (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  course_id BIGINT NOT NULL,
  title VARCHAR(200) NOT NULL,
  sort_order INT DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE
);

-- videos
CREATE TABLE videos (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  section_id BIGINT NOT NULL,
  title VARCHAR(200) NOT NULL,
  source_url VARCHAR(255) NOT NULL,
  hls_url VARCHAR(255),
  duration_seconds INT DEFAULT 0,
  size_bytes BIGINT DEFAULT 0,
  sort_order INT DEFAULT 0,
  is_free_preview TINYINT DEFAULT 0,
  transcode_status ENUM('ORIGINAL','TRANSCODING','HLS_READY','FAILED') DEFAULT 'ORIGINAL',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (section_id) REFERENCES sections(id) ON DELETE CASCADE
);

-- enrollments
CREATE TABLE enrollments (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  course_id BIGINT NOT NULL,
  status ENUM('ACTIVE','COMPLETED','DROPPED') DEFAULT 'ACTIVE',
  enrolled_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uq_user_course (user_id, course_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE
);

-- video_progress
CREATE TABLE video_progress (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  video_id BIGINT NOT NULL,
  last_position_seconds INT NOT NULL DEFAULT 0,
  max_position_seconds INT NOT NULL DEFAULT 0,
  percentage DECIMAL(5,2) NOT NULL DEFAULT 0.00,
  is_completed TINYINT NOT NULL DEFAULT 0,
  playback_rate DECIMAL(3,2) NOT NULL DEFAULT 1.00,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uq_user_video (user_id, video_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE
);

-- favorites
CREATE TABLE favorites (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  course_id BIGINT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uq_fav (user_id, course_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE
);

-- play_history
CREATE TABLE play_history (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  video_id BIGINT NOT NULL,
  position_seconds INT DEFAULT 0,
  watched_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE
);

-- audit_logs
CREATE TABLE audit_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  operator_id BIGINT,
  action VARCHAR(50) NOT NULL,
  target_type VARCHAR(50),
  target_id BIGINT,
  details TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

------

## 15. 进度计算与“继续学习”规则

- **视频完成**：`is_completed=1` 当 `last_position_seconds >= duration_seconds * 0.9` 或收到 `end` 事件。
- **百分比**：`percentage = round(max_position_seconds / duration_seconds * 100, 2)`（上限 100）。
- **课程进度**：`已完成视频数 / 总视频数`（保留两位小数）。
- **继续学习**：从“最近学习的视频”中选**第一个未完成视频**作为跳转目标；若全完成则提示“已学完”。

------

## 16. 日志与审计

- 接口访问日志（INFO）、异常（ERROR）。
- 管理操作（增删改发布）写入 `audit_logs`，含操作者、对象、时间、详情快照。

------

## 17. 部署建议（演示环境）

- **Nginx**：反向代理 `/api` 到 Spring Boot；`/` 静态资源指向前端构建产物；限制 `uploads` 目录直链，走后端鉴权。
- **Java**：JDK 17；**Maven** 构建。
- **数据库**：MySQL 8；初始化脚本 + Flyway。
- **配置**：`application-dev.yml` 中配置本地 MySQL：`jdbc:mysql://localhost:3306/learn?useSSL=false&serverTimezone=UTC`，用户名 `root`、密码 `1234`（仅开发）。

------

## 18. 未来扩展（v1.1+）

- HLS 多码率，CDN 分发，预签名 URL。
- 分块/断点续传上传；转码任务队列（Redis + 异步）。
- 防刷课升级：观看区间与有效可视前台在屏检测。
- 题库与证书、学习报告导出（CSV/Excel）。
- OAuth 第三方登录（GitHub/微信等）。

------

## 19. 附：示例接口交互（时序，简化）

```
学员 → 前端：打开视频页(videoId)
前端 → 后端：GET /videos/{id}/progress
后端 → 前端：返回 { lastPosition: 120, isCompleted: false }

（用户选择“从 2:00 继续”）
前端：video.currentTime = 120；开始播放

（播放中每5s）
前端 → 后端：PATCH /videos/{id}/progress { positionSeconds: 125, ... }
后端：UPSERT video_progress & 返回最新 percentage

（播放结束）
前端 → 后端：PATCH /videos/{id}/progress { event: "end", positionSeconds: duration }
后端：设置 is_completed=1；触发课程聚合更新
```

------

如果你愿意，我可以**按此 PRD 再帮你生成**：

- 接口 Swagger 注释模板、
- Vue 路由/页面骨架清单、
- Spring Boot 实体/仓库/控制器样板代码、
- 或者把上面的 SQL 导出为 `.sql` 文件，方便你一键导入。